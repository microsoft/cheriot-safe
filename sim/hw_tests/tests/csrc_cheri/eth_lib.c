#include <stdio.h>
#include <stdlib.h>

unsigned char frame0[60] = {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x78, 0x31, 
                           0xc1, 0xd0, 0xe1, 0xb8, 0x8,  0x6,  0x0,  0x1, 
                           0x8,  0x0,  0x6,  0x4,  0x0,  0x1,  0x78, 0x31, 
                           0xc1, 0xd0, 0xe1, 0xb8, 0xc0, 0xa8, 0x1,  0xe8, 
                           0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0xc0, 0xa8, 
                           0x1,  0x7e, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 
                           0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 
                           0x0,  0x0,  0x0,  0x0
                           };
// test data 1 - an IP v6 multicast packet, captured from wire
unsigned char frame1[86] = { 0x33, 0x33, 0xff, 0xe6, 0x63, 0x30, 0x60, 0x8d, 
                            0x26, 0xa9, 0xa5, 0x9c, 0x86, 0xdd, 0x6b, 0x80, 
                            0x0, 0x0, 0x0, 0x20, 0x3a, 0xff, 0xfe, 0x80, 
                            0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x62, 0x8d, 
                            0x26, 0xff, 0xfe, 0xa9, 0xa5, 0x9c, 0xff, 0x2, 
                            0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
                            0x0, 0x1, 0xff, 0xe6, 0x63, 0x30, 0x87, 0x0, 
                            0xcb, 0xe2, 0x0, 0x0, 0x0, 0x0, 0x2a, 0x0, 
                            0x23, 0xc6, 0x54, 0xdd, 0x10, 0x1, 0x89, 0xd3, 
                            0x1c, 0xf0, 0x33, 0xe6, 0x63, 0x30, 0x1, 0x1, 
                            0x60, 0x8d, 0x26, 0xa9, 0xa5, 0x9c 
                            };

// test data 2 - just incremental data pattern, crc locally generated
unsigned char frame2[45] = {0x55, 0xaa, 0x55, 0xaa, 0x55, 0xaa, 0x55, 0xaa, 
                           0x12, 0x34, 0x56, 0x78, 0xde, 0xad, 0xbe, 0xef, 
                           0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 
                           0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10, 
                           0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 
                           0x19, 0x1a, 0x1b, 0x1c, 0x1d 
                           };

// test data 3 - ipv4 multicast packet, patial capture, crc locally generated
unsigned char frame3[48] = {0x1,  0x0,  0x5e, 0x0,  0x0,  0xfb, 0x64, 0xc9, 
                           0x1,  0xb5, 0x6,  0x22, 0x8,  0x0,  0x45, 0x0, 
                           0x0,  0x95, 0x62, 0x4e, 0x0,  0x0,  0xff, 0x11, 
                           0xb6, 0x12, 0xc0, 0xa8, 0x1,  0x53, 0xe0, 0x0, 
                           0x0,  0xfb, 0x14, 0xe9, 0x14, 0xe9, 0x0,  0x81, 
                           0x78, 0x0,  0x8,  0xc0, 0xc,  0x0,  0x4,  0x40
                           };
unsigned char frame4[254] = {
0x33 , 0x33 , 0x00 , 0x00 , 0x00 , 0xFB , 0xD2 , 0x09, 
0xDB , 0x38 , 0x07 , 0x86 , 0x86 , 0xDD , 0x60 , 0x0E, 
0x09 , 0x00 , 0x00 , 0xC8 , 0x11 , 0xFF , 0xFE , 0x80, 
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x18 , 0xA5,
0xA6 , 0x0E , 0xE5 , 0x21 , 0xEE , 0x0C , 0xFF , 0x02, 
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, 
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFB , 0x14 , 0xE9, 
0x14 , 0xE9 , 0x00 , 0xC8 , 0x4C , 0xFD , 0x00 , 0x00, 
0x84 , 0x00 , 0x00 , 0x00 , 0x00 , 0x03 , 0x00 , 0x00, 
0x00 , 0x01 , 0x10 , 0x4D , 0x61 , 0x72 , 0x74 , 0x69, 
0x6E , 0x65 , 0xE2 , 0x80 , 0x99 , 0x73 , 0x20 , 0x69, 
0x50 , 0x61 , 0x64 , 0x0C , 0x5F , 0x64 , 0x65 , 0x76, 
0x69 , 0x63 , 0x65 , 0x2D , 0x69 , 0x6E , 0x66 , 0x6F, 
0x04 , 0x5F , 0x74 , 0x63 , 0x70 , 0x05 , 0x6C , 0x6F, 
0x63 , 0x61 , 0x6C , 0x00 , 0x00 , 0x10 , 0x00 , 0x01, 
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x0D , 0x0C , 0x6D, 
0x6F , 0x64 , 0x65 , 0x6C , 0x3D , 0x4A , 0x37 , 0x32, 
0x73 , 0x41 , 0x50 , 0x07 , 0x5F , 0x72 , 0x64 , 0x6C, 
0x69 , 0x6E , 0x6B , 0xC0 , 0x2A , 0x00 , 0x0C , 0x00, 
0x01 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x13 , 0x10, 
0x4D , 0x61 , 0x72 , 0x74 , 0x69 , 0x6E , 0x65 , 0xE2, 
0x80 , 0x99 , 0x73 , 0x20 , 0x69 , 0x50 , 0x61 , 0x64, 
0xC0 , 0x4D , 0x0F , 0x5F , 0x63 , 0x6F , 0x6D , 0x70, 
0x61 , 0x6E , 0x69 , 0x6F , 0x6E , 0x2D , 0x6C , 0x69, 
0x6E , 0x6B , 0xC0 , 0x2A , 0x00 , 0x0C , 0x00 , 0x01, 
0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x13 , 0x10 , 0x4D, 
0x61 , 0x72 , 0x74 , 0x69 , 0x6E , 0x65 , 0xE2 , 0x80, 
0x99 , 0x73 , 0x20 , 0x69 , 0x50 , 0x61 , 0x64 , 0xC0, 
0x74 , 0x00 , 0x00 , 0x29 , 0x05 , 0xA0 , 0x00 , 0x00, 
0x11 , 0x94 , 0x00 , 0x12 , 0x00 , 0x04 , 0x00 , 0x0E, 
0x00 , 0x66 , 0xB6 , 0x9C , 0xDF , 0xBF , 0x0A , 0x47, 
0xD2 , 0x09 , 0xDB , 0x38 , 0x07 , 0x86
};

volatile unsigned int *eth_base;

unsigned int mdio_write(unsigned int reg_addr, unsigned int wdata) {
  *(eth_base + 4) =  (1<<5) | (reg_addr & 0x1f);
  *(eth_base + 5) = wdata;
  *(eth_base + 7) = 0x1;
  while ((*(eth_base+7)) & 0x1) {;}
  return 0;
}

unsigned int mdio_read(unsigned int reg_addr) {
  *(eth_base + 4) = (1 << 10) | (1<<5) | (reg_addr & 0x1f);
  *(eth_base + 7) = 0x1;
  while ((*(eth_base+7)) & 0x1) {;}
  return (*(eth_base + 6)) ;
}

int dump_rx_buf(unsigned int rx_num, unsigned int plen) {
  volatile unsigned int *rx_ptr;
  unsigned int rx_stat, rx_len, rx_data;
  unsigned char rx_bytes[4];
  int i;

  if (rx_num == 0) {
    rx_stat = *(eth_base + 12);
    rx_ptr = eth_base + 0x2000/4;
    rx_len = rx_stat >> 16;
  } else {
    rx_stat = *(eth_base + 13);
    rx_ptr = eth_base + 0x2800/4;
    rx_len = rx_stat >> 16;
  }

  printf("Printing rx buffer %d, stat = %08x, rx byte cnt = %d\n", rx_num, rx_stat, rx_len);
  if (plen < rx_len) {plen = rx_len;}

  for (i = 0; i <= plen/4; i++ ) {
    rx_data = *rx_ptr;
    rx_bytes[0] = rx_data & 0xff;
    rx_bytes[1] = (rx_data >> 8) & 0xff;
    rx_bytes[2] = (rx_data >> 16) & 0xff;
    rx_bytes[3] = (rx_data >> 24) & 0xff;
    printf("%02x %02x %02x %02x ", rx_bytes[0], rx_bytes[1], rx_bytes[2], rx_bytes[3]);
    rx_ptr++;
    if (i%2==1) {printf("\n");}
  }
  printf("\n");

  return 0;
}

void dump_phy_regs(void) {
  int i;
  unsigned int rdata;

  printf("====== Printing PHY registers =======\n");
  for (i=0; i<32; i++) {
    rdata = mdio_read(i);
    printf("PHY_reg %d = %08x\n", i, rdata);
  }
}

void dump_mac_regs(void) {
  int i;
  unsigned int rdata;

  printf("====== Printing MAC registers ======\n");
  for (i=0; i<32; i++) {
    rdata = *(eth_base+i);
    printf("MAC_reg %d = %08x\n", i, rdata);
    if (i==26) {  // double read since it's CDC
      rdata = *(eth_base+i);
      printf("-- MAC_reg %d = %08x\n", i, rdata);
    }
  }
}

int send_tx_frame(unsigned int frame_id) {
  volatile unsigned char *tx_buf;
  unsigned char *frame_ptr;
  unsigned int  frame_len;
  int i;

  switch (frame_id) {
    case 0: 
      frame_ptr = frame0;
      frame_len = 60;
      break;
    case 1: 
      frame_ptr = frame1;
      frame_len = 86;
      break;
    case 2: 
      frame_ptr = frame2;
      frame_len = 45;
      break;
    case 3: 
      frame_ptr = frame3;
      frame_len = 48;
      break;
    case 4: 
      frame_ptr = frame4;
      frame_len = 254;
      break;
    default:
      frame_ptr = frame0;
      frame_len = 60;
  }

  while (((*(eth_base+9))&0x1) && ((*(eth_base+11))&0x1)) {;} 
  if (((*(eth_base+9))&0x1) == 0) {
    // printf("Send 0\n");
    tx_buf = ((unsigned char *)eth_base + 0x1000);
    for (i = 0; i < frame_len; i++) {tx_buf[i] = frame_ptr[i];}
    *(eth_base+8) = frame_len;
    *(eth_base+9) = 0x1; 
  } else {
    // printf("Send 1\n");
    tx_buf = ((unsigned char *)eth_base + 0x1800);
    for (i = 0; i < frame_len; i++) {tx_buf[i] = frame_ptr[i];}
    *(eth_base+10) = frame_len;
    *(eth_base+11) = 0x1; 
  }

  return 0;
}

int find_rx_frame(void) {
  if ((*(eth_base+12))&0x1) {
    return 0; 
  } else if ((*(eth_base+13))&0x1) {
    return 1;
  } else {
    return -1;
  }
};

void release_rx_buf(unsigned int rx_buf_id) {
  if (rx_buf_id == 0) {
   *(eth_base+12) = 1;
  } else if (rx_buf_id == 1) {
   *(eth_base+13) = 1;
  }
}

int check_rx_frame(unsigned int rx_buf_id, unsigned int frame_id) {
  volatile unsigned char *rx_buf;
  unsigned char *frame_ptr;
  unsigned int  frame_len;
  unsigned int  rx_stat;
  int i, flag;

  printf("checking rx buffer %d with frame %d\n", rx_buf_id, frame_id);
  switch (frame_id) {
    case 0: 
      frame_ptr = frame0;
      frame_len = 60;
      break;
    case 1: 
      frame_ptr = frame1;
      frame_len = 86;
      break;
    case 2: 
      frame_ptr = frame2;
      frame_len = 45;
      break;
    case 3: 
      frame_ptr = frame3;
      frame_len = 48;
      break;
    case 4: 
      frame_ptr = frame4;
      frame_len = 254;
      break;
    default:
      frame_ptr = frame0;
      frame_len = 60;
  }

 
  if (rx_buf_id == 0) {
    rx_stat = *(eth_base + 12);
    rx_buf = ((unsigned char *)eth_base + 0x2000);
  } else if (rx_buf_id == 1) {
    rx_stat = *(eth_base + 13);
    rx_buf = ((unsigned char *)eth_base + 0x2800);
  } else {
    return -1;
  }

  if (((rx_stat >> 1) & 0x1)!= 0) {
    printf("ERROR: check_rx: rx_stat %d = %08x\n", rx_buf_id, rx_stat);
    return -1;
  }

  flag = 0;
  for (i = 0; i<frame_len; i++) {
    if (rx_buf[i] != frame_ptr[i]) {flag = -1;}
  }
  return flag;
}
